<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Smart Filter by karan469</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Smart Filter</h1>
      <h2 class="project-tagline">This repository aims to create smart filters, majorly for selfies.</h2>
      <a href="https://github.com/karan469/Smart-Filter" class="btn">View on GitHub</a>
      <a href="https://github.com/karan469/Smart-Filter/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/karan469/Smart-Filter/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <p>Aim of this project is to create <strong>end-to-end pipeline</strong> from engineering machine learning model to deployement of the same. This is achieved using <em>Docker</em> and <em>Flask</em> as microservice to host the learned model on an EC2 instance. Seperate models are trained on <a href="https://cocodataset.org/">COCOdataset</a> using detectron2 on pytorch and other datasets using <em>tensorflow-gpu.</em></p>
<p><strong>UPDATE (01-08-20): Smile Detection is now backed on ResNet50 architecture! The model is more robust and accurate than ever.</strong></p>
<p><strong>UPDATE (25-07-20): Released the code as of now. Web app will be deployed soon!</strong></p>
<p><strong>THE REPOSITORY IS PRIVATE AS OF NOW. ONCE I DEPLOY THE PROJECT ON A WEB/MOBILE APP USING AWS EC2,  I WILL RELEASE THE SOURCE CODE.</strong></p>
<h2>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h2>
<p>Smart filter uses machine <strong>learning to curate image specific filters and background</strong>. There will be little to no input of user in deciding the final image.
Smart filter is a useful tool to interact and share pictures across social media. 100s of thousands of images are uploaded every single minute. These picures take many forms such as stories, posts, comments, stickers and more.</p>
<p>There are 2 parts to this project:</p>
<ul>
<li>Semantic Segmentation and face detection using <a href="https://github.com/facebookresearch/detectron2">Detectron2 - Facebook AI</a>
</li>
<li>Smile detection on detected face.</li>
</ul>
<h2>
<a id="requirements" class="anchor" href="#requirements" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Requirements</h2>
<ol>
<li>detectron2</li>
<li>pytorch</li>
<li>cuda 10.1</li>
<li>tensorflow</li>
<li>torchvision</li>
</ol>
<h2>
<a id="examples" class="anchor" href="#examples" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Examples</h2>
<h3>
<a id="background-removal" class="anchor" href="#background-removal" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Background Removal</h3>
<p>This API can be used to remove background and place either a fixed preset, or another aesthetically good looking background using parameters given by user.</p>
<div class="highlight highlight-source-python"><pre><span class="pl-s1">path</span> <span class="pl-c1">=</span> <span class="pl-s">'/content/'</span>
<span class="pl-c">#returns necessary attrbutes and results from model output</span>
<span class="pl-s1">im</span>, <span class="pl-s1">human_masks</span>, <span class="pl-s1">boxes</span> <span class="pl-c1">=</span> <span class="pl-en">return_attributes</span>(<span class="pl-s1">path</span><span class="pl-c1">+</span><span class="pl-s">'me.jpg'</span>)
<span class="pl-en">print</span>(<span class="pl-s">'Masks calculated'</span>)

<span class="pl-c"># list of singular human images</span>
<span class="pl-s1">final_images</span> <span class="pl-c1">=</span> <span class="pl-en">bound_human_boxes</span>(<span class="pl-s1">boxes</span>)

<span class="pl-c"># final mask =&gt; NxM bool matrix : value is 1 if human is present on the pixel</span>
<span class="pl-s1">final_mask</span> <span class="pl-c1">=</span> <span class="pl-en">return_union_mask</span>(<span class="pl-s1">im</span>, <span class="pl-s1">human_masks</span>)
<span class="pl-en">print</span>(<span class="pl-s">'Final Mask created'</span>)

<span class="pl-c"># Remove background and show the resultant image </span>
<span class="pl-en">cv2_imshow</span>(<span class="pl-en">remove_bg</span>(<span class="pl-s1">im</span>, <span class="pl-s1">final_mask</span>))</pre></div>
<table>
<thead>
<tr>
<th align="center">Original Image</th>
<th align="center">Background removal using Semantic Segmentation</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><img src="https://raw.githubusercontent.com/karan469/Smart-Filter/master/Semantic%20Segmentation/person_selfie.jpg?token=AH47IOS6OXNRCYXIJROA7F27EV6QY" alt=""></td>
<td align="center"><img src="https://raw.githubusercontent.com/karan469/Smart-Filter/master/Semantic%20Segmentation/unsplashFilter_x.jpg?token=AH47IOTHPSS2QMG6EGZ2DMS7EV6VS" alt=""></td>
</tr>
</tbody>
</table>
<h3>
<a id="face-detection-using-transfer-learning-on-detectron2" class="anchor" href="#face-detection-using-transfer-learning-on-detectron2" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Face detection using transfer learning on detectron2</h3>
<p>This model is created using 500 images with 1100 instances on faces in the <a href="https://www.kaggle.com/dataturks/face-detection-in-images">dataset</a>
Thus, the learning is not as rigorous as it could be. But I have achieved an <strong>F1 score of 0.702</strong> which was good enough.</p>
<blockquote>
<p>Insert model quality metrics.</p>
</blockquote>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">return_face_detection_predictor</span>(<span class="pl-s1">filename</span>):
    <span class="pl-k">from</span> <span class="pl-s1">detectron2</span>.<span class="pl-s1">config</span> <span class="pl-k">import</span> <span class="pl-s1">get_cfg</span>

    <span class="pl-v">MODEL_PATH</span> <span class="pl-c1">=</span> <span class="pl-s">'COCO-Detection/retinanet_R_101_FPN_3x.yaml'</span>
    <span class="pl-s1">cfg</span> <span class="pl-c1">=</span> <span class="pl-en">get_cfg</span>()
    <span class="pl-s1">cfg</span>.<span class="pl-en">merge_from_file</span>(<span class="pl-s1">model_zoo</span>.<span class="pl-en">get_config_file</span>(<span class="pl-v">MODEL_PATH</span>))
    <span class="pl-s1">cfg</span>.<span class="pl-v">MODEL</span>.<span class="pl-v">WEIGHTS</span> <span class="pl-c1">=</span> <span class="pl-s1">filename</span>
    <span class="pl-s1">cfg</span>.<span class="pl-v">MODEL</span>.<span class="pl-v">RETINANET</span>.<span class="pl-v">NUM_CLASSES</span> <span class="pl-c1">=</span> <span class="pl-c1">1</span>
    <span class="pl-s1">cfg</span>.<span class="pl-v">MODEL</span>.<span class="pl-v">RETINANET</span>.<span class="pl-v">SCORE_THRESH_TEST</span> <span class="pl-c1">=</span> <span class="pl-c1">0.50</span>

    <span class="pl-k">return</span> <span class="pl-v">DefaultPredictor</span>(<span class="pl-s1">cfg</span>)

<span class="pl-s1">face_predictor</span> <span class="pl-c1">=</span> <span class="pl-en">return_face_detection_predictor</span>(<span class="pl-s">'/content/drive/My Drive/Colab Notebooks/checkpoint_face.pth'</span>)
<span class="pl-s1">face_detection_output</span> <span class="pl-c1">=</span> <span class="pl-en">face_predictor</span>(<span class="pl-s1">im</span>)
<span class="pl-s1">pred_boxes</span> <span class="pl-c1">=</span> <span class="pl-s1">np</span>.<span class="pl-en">array</span>(<span class="pl-s1">face_detection_output</span>[<span class="pl-s">'instances'</span>].<span class="pl-s1">_fields</span>[<span class="pl-s">'pred_boxes'</span>].<span class="pl-s1">tensor</span>.<span class="pl-en">cpu</span>(), <span class="pl-s1">dtype</span><span class="pl-c1">=</span><span class="pl-s">'int32'</span>)</pre></div>
<table>
<thead>
<tr>
<th align="center">Image 1</th>
<th align="center">Image 2</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><img src="https://raw.githubusercontent.com/karan469/Smart-Filter/master/Face%20detection%20using%20Detectron2/index.png?token=AH47IOWSX2DSJSE7Y2MVOK27EV6XM" alt=""></td>
<td align="center"><img src="https://raw.githubusercontent.com/karan469/Smart-Filter/master/Face%20detection%20using%20Detectron2/index1.png?token=AH47IOVOQKOZOVTLIHQB7BK7EV6ZI" alt=""></td>
</tr>
</tbody>
</table>
<p>Right now, Face Filter is used primarily for selfies thus, the achieved results are satisfactory.</p>
<h3>
<a id="smile-detection" class="anchor" href="#smile-detection" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Smile Detection</h3>
<p>Selfies taken are inherently full of features which can be used to automate creating appropriate face filters. For example, facial features can be used as a good way to describe a selfie. I have created only smile detection so far.<br>
The final model predicts on a given face. You can use either a Haar features based frontal face cascade or another pretrained CNN model to localise the faces in image.</p>
<blockquote>
<p>Insert model quality metrics.</p>
</blockquote>
<div class="highlight highlight-source-python"><pre><span class="pl-s1">smile_predictor</span> <span class="pl-c1">=</span> <span class="pl-v">SmileModel</span>(<span class="pl-s">'/content/drive/My Drive/Colab Notebooks/smiledetection.h5'</span>)
<span class="pl-s1">temp</span> <span class="pl-c1">=</span> <span class="pl-s1">cv2</span>.<span class="pl-en">resize</span>(<span class="pl-s1">temp</span>, <span class="pl-s1">dsize</span><span class="pl-c1">=</span>(<span class="pl-c1">64</span>, <span class="pl-c1">64</span>))
<span class="pl-s1">temp</span> <span class="pl-c1">=</span> <span class="pl-s1">temp</span>.<span class="pl-en">reshape</span>(<span class="pl-c1">1</span>, <span class="pl-c1">64</span>, <span class="pl-c1">64</span>, <span class="pl-c1">3</span>)
<span class="pl-s1">probability</span> <span class="pl-c1">=</span> <span class="pl-s1">smile_predictor</span>.<span class="pl-en">predict</span>(<span class="pl-s1">temp</span>)</pre></div>
<table>
<thead>
<tr>
<th align="center">Image 1</th>
<th align="center">Image 2</th>
<th align="center">Image 3</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><img src="https://raw.githubusercontent.com/karan469/Smart-Filter/master/Smile%20Detection/1.png?token=AH47IOWYBKH2FDGM3BVH4OS7EV64C" alt=""></td>
<td align="center"><img src="https://raw.githubusercontent.com/karan469/Smart-Filter/master/Smile%20Detection/2.png?token=AH47IOWKKF7FETGXOB73JN27EV65U" alt=""></td>
<td align="center"><img src="https://raw.githubusercontent.com/karan469/Smart-Filter/master/Smile%20Detection/not%20smiling.png?token=AH47IOQO3LM5BKZO3UBSJCC7EV7BS" alt=""></td>
</tr>
</tbody>
</table>
<h2>
<a id="smart-filters-examples" class="anchor" href="#smart-filters-examples" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Smart Filters examples</h2>
<table>
<thead>
<tr>
<th align="center">Input</th>
<th align="center">Output</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><img src="https://raw.githubusercontent.com/karan469/Smart-Filter/master/Final%20Ensemble/selfie1.png?token=AH47IOROGL7Q3CBZK4LFJES7EV7OQ" alt=""></td>
<td align="center"><img src="https://raw.githubusercontent.com/karan469/Smart-Filter/master/Final%20Ensemble/index5.png?token=AH47IORH3SE6IJUPXR64RIC7EV7QW" alt=""></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th align="center">Input</th>
<th align="center">Output</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><img src="https://raw.githubusercontent.com/karan469/Smart-Filter/master/Final%20Ensemble/5449.png?token=AH47IOULOHHVVFIXKAYCO627EV7SK" alt=""></td>
<td align="center"><img src="https://raw.githubusercontent.com/karan469/Smart-Filter/master/Final%20Ensemble/index6.png?token=AH47IOR2AYDE4TBP5XL6I6C7EV7T4" alt=""></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th align="center">Input</th>
<th align="center">Output</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><img src="https://raw.githubusercontent.com/karan469/Smart-Filter/master/Final%20Ensemble/me_orig_x.jpg?token=AH47IOX6YFTKCJEVMQ6B2AK7EV7VU" alt=""></td>
<td align="center"><img src="https://raw.githubusercontent.com/karan469/Smart-Filter/master/Semantic%20Segmentation/supportpride.png?token=AH47IOU254CE7YMV2AFZF6S7EV7YA" alt=""></td>
</tr>
</tbody>
</table>
<p>Last image is created by giving 'rainbow,texture' as parameters to background selection.</p>
<blockquote>
<p>Insert code snippet.</p>
</blockquote>
<h2>
<a id="id-️-suggestions-" class="anchor" href="#id-%EF%B8%8F-suggestions-" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>I'd <g-emoji class="g-emoji" alias="heart" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png">❤️</g-emoji> suggestions ..</h2>
<ol>
<li>Point me in the direction of a good dataset for human facial features detection, and face detection (Bigger the better). Currently, I am using transfer learning for face detection, on a small dataset of 500 images and 1100 faces only, which is giving only satisfactory results.</li>
<li>There are some big possible improvements that could be done, such as multi-task learning. This might reduce latency in providing results, by a huge margin. Let me know your thoughts on that!</li>
</ol>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/karan469/Smart-Filter">Smart Filter</a> is maintained by <a href="https://github.com/karan469">karan469</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>


  </body>
</html>
